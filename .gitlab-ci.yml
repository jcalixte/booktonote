# GitLab CI/CD Configuration for BookToNote OCR Server

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# Build Docker image
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
  only:
    - main
    - tags
    - branches

# Test the built image
test:
  stage: test
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $IMAGE_TAG
    # Start the container
    - docker run -d --name ocr-test -p 8080:8080 $IMAGE_TAG
    # Wait for server to start
    - sleep 10
    # Test health endpoint
    - apk add --no-cache curl
    - curl -f http://localhost:8080/health || exit 1
    # Test API documentation endpoint
    - curl -f http://localhost:8080/ || exit 1
    # Cleanup
    - docker stop ocr-test
    - docker rm ocr-test
  only:
    - main
    - tags
    - branches
  dependencies:
    - build

# Deploy to production (manual trigger)
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying $IMAGE_TAG to production"
    - echo "Pull the image on your server with:"
    - echo "docker pull $IMAGE_TAG"
    - echo "docker run -d -p 8080:8080 --name booktonote-ocr $IMAGE_TAG"
  when: manual
  only:
    - main
    - tags
  environment:
    name: production
    url: http://your-server:8080

# Deploy to staging (automatic)
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying $IMAGE_TAG to staging"
    - echo "Image available at $IMAGE_TAG"
  only:
    - main
  environment:
    name: staging
    url: http://staging-server:8080
